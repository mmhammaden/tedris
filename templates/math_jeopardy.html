{% extends "base.html" %}

{% block title %}Math Jeopardy - ØªØ¯Ø±ÙŠØ³{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50">
    <!-- Game Header -->
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ğŸ§® Math Jeopardy</h1>
                    <p class="text-purple-100">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold" id="score-display">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
                    <div class="text-sm text-purple-100" id="progress-display">Ø§Ù„Ø³Ø¤Ø§Ù„: 0/12</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Language Selection (Initial Screen) -->
        <div id="language-selection" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Ø§Ø®ØªØ± Ù„ØºØ© Ø§Ù„Ù„Ø¹Ø¨</h2>
            <div class="space-y-4">
                <button onclick="startGame('arabic')" 
                        class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 px-6 rounded-lg font-semibold hover:from-blue-600 hover:to-blue-700 transition-colors duration-200">
                    ğŸ‡²ğŸ‡· Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
                </button>
                <button onclick="startGame('french')" 
                        class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-6 rounded-lg font-semibold hover:from-green-600 hover:to-green-700 transition-colors duration-200">
                    ğŸ‡«ğŸ‡· FranÃ§ais
                </button>
                <button onclick="startGame('mixed')" 
                        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 px-6 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-colors duration-200">
                    ğŸŒ Ù…Ø®ØªÙ„Ø· / Mixte
                </button>
            </div>
            <div class="mt-6">
                <a href="{{ url_for('games') }}" class="text-gray-500 hover:text-gray-700">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ù„Ø¹Ø§Ø¨</a>
            </div>
        </div>

        <!-- Game Board -->
        <div id="game-board" class="hidden">
            <div class="grid grid-cols-3 gap-4 max-w-4xl mx-auto mb-8">
                <!-- Categories will be populated by JavaScript -->
            </div>
        </div>

        <!-- Question Modal -->
        <div id="question-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-8">
                <div class="text-center mb-6">
                    <div class="text-lg font-semibold text-gray-600" id="question-category"></div>
                    <div class="text-3xl font-bold text-purple-600" id="question-points"></div>
                </div>
                
                <div class="mb-8">
                    <p class="text-xl text-gray-800 text-center" id="question-text"></p>
                </div>
                
                <div class="mb-6">
                    <input type="text" id="answer-input" 
                           class="w-full p-4 border-2 border-gray-300 rounded-lg text-lg text-center focus:border-purple-500 focus:outline-none"
                           placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§...">
                </div>
                
                <div class="flex gap-4">
                    <button onclick="submitAnswer()" 
                            class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-green-600 hover:to-green-700 transition-colors duration-200">
                        Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                    </button>
                    <button onclick="closeQuestionModal()" 
                            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-colors duration-200">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>

        <!-- Answer Result Modal -->
        <div id="result-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-8">
                <div class="text-center mb-6">
                    <div id="result-icon" class="text-6xl mb-4"></div>
                    <div id="result-message" class="text-2xl font-bold mb-2"></div>
                    <div id="result-points" class="text-lg text-gray-600"></div>
                </div>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="font-semibold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</div>
                    <div id="correct-answer" class="text-lg text-green-600 font-bold"></div>
                    <div id="explanation" class="text-gray-600 mt-2"></div>
                </div>
                
                <button onclick="closeResultModal()" 
                        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-6 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-colors duration-200">
                    Ù…ØªØ§Ø¨Ø¹Ø©
                </button>
            </div>
        </div>

        <!-- Game Complete Modal -->
        <div id="complete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 p-8 text-center">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!</h2>
                <div class="mb-6">
                    <div class="text-3xl font-bold text-purple-600 mb-2" id="final-score"></div>
                    <div class="text-gray-600" id="final-stats"></div>
                </div>
                <div class="flex gap-4">
                    <button onclick="location.reload()" 
                            class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 px-4 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition-colors duration-200">
                        Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                    </button>
                    <a href="{{ url_for('games') }}" 
                       class="flex-1 bg-gray-300 text-gray-700 py-3 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-colors duration-200 text-center">
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ù„Ø¹Ø§Ø¨
                    </a>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
let gameSession = null;
let gameBoard = {};
let currentQuestion = null;
let questionsAnswered = 0;
let totalQuestions = 0;

async function startGame(languageMode) {
    try {
        const response = await fetch('/api/games/math-jeopardy/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ language_mode: languageMode })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            gameSession = data.session_id;
            gameBoard = data.board;
            
            // Count total questions
            totalQuestions = 0;
            Object.values(gameBoard).forEach(category => {
                totalQuestions += Object.keys(category).length;
            });
            
            document.getElementById('language-selection').classList.add('hidden');
            document.getElementById('game-board').classList.remove('hidden');
            
            renderGameBoard();
        } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
        }
    } catch (error) {
        console.error('Error starting game:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
}

function renderGameBoard() {
    const boardElement = document.getElementById('game-board').querySelector('.grid');
    boardElement.innerHTML = '';
    
    Object.entries(gameBoard).forEach(([category, questions]) => {
        // Category header
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 rounded-lg text-center font-bold text-lg';
        categoryDiv.textContent = category;
        boardElement.appendChild(categoryDiv);
        
        // Questions
        Object.entries(questions).forEach(([points, questionData]) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = questionData.answered 
                ? 'bg-gray-300 text-gray-500 p-6 rounded-lg text-center font-bold text-2xl cursor-not-allowed'
                : 'bg-white hover:bg-gray-50 p-6 rounded-lg text-center font-bold text-2xl cursor-pointer border-2 border-gray-200 hover:border-purple-300 transition-colors duration-200';
            questionDiv.textContent = questionData.answered ? 'âœ“' : points;
            
            if (!questionData.answered) {
                questionDiv.onclick = () => openQuestion(questionData.id, category, points);
            }
            
            boardElement.appendChild(questionDiv);
        });
    });
}

async function openQuestion(questionId, category, points) {
    try {
        const response = await fetch(`/api/games/math-jeopardy/question/${questionId}`);
        const data = await response.json();
        
        if (response.ok) {
            currentQuestion = { ...data, points: parseInt(points) };
            
            document.getElementById('question-category').textContent = category;
            document.getElementById('question-points').textContent = `${points} Ù†Ù‚Ø·Ø©`;
            document.getElementById('question-text').textContent = data.question_ar || data.question_fr;
            document.getElementById('answer-input').value = '';
            document.getElementById('question-modal').classList.remove('hidden');
            document.getElementById('answer-input').focus();
        }
    } catch (error) {
        console.error('Error loading question:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„');
    }
}

async function submitAnswer() {
    const answer = document.getElementById('answer-input').value.trim();
    if (!answer) {
        alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø©');
        return;
    }
    
    try {
        const response = await fetch('/api/games/math-jeopardy/answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_id: currentQuestion.id,
                answer: answer,
                session_id: gameSession,
                language_mode: 'arabic' // This should be stored from game start
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Update score display
            document.getElementById('score-display').textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${data.total_score}`;
            document.getElementById('progress-display').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„: ${data.questions_answered}/${totalQuestions}`;
            
            // Mark question as answered
            Object.values(gameBoard).forEach(category => {
                Object.values(category).forEach(question => {
                    if (question.id === currentQuestion.id) {
                        question.answered = true;
                    }
                });
            });
            
            // Show result
            document.getElementById('result-icon').textContent = data.correct ? 'âœ…' : 'âŒ';
            document.getElementById('result-message').textContent = data.correct ? 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!' : 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©';
            document.getElementById('result-points').textContent = data.correct ? `+${data.points_earned} Ù†Ù‚Ø·Ø©` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø·';
            document.getElementById('correct-answer').textContent = data.correct_answer;
            document.getElementById('explanation').textContent = data.explanation || '';
            
            document.getElementById('question-modal').classList.add('hidden');
            document.getElementById('result-modal').classList.remove('hidden');
            
            questionsAnswered++;
            
        } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©');
        }
    } catch (error) {
        console.error('Error submitting answer:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
}

function closeQuestionModal() {
    document.getElementById('question-modal').classList.add('hidden');
}

function closeResultModal() {
    document.getElementById('result-modal').classList.add('hidden');
    renderGameBoard();
    
    // Check if game is complete
    if (questionsAnswered >= totalQuestions) {
        showGameComplete();
    }
}

function showGameComplete() {
    const score = document.getElementById('score-display').textContent;
    const correctAnswers = Math.round((parseInt(score.split(': ')[1]) / 200) * 100) / 100; // Rough calculation
    
    document.getElementById('final-score').textContent = score;
    document.getElementById('final-stats').textContent = `Ø£Ø¬Ø¨Øª Ø¹Ù„Ù‰ ${questionsAnswered} Ø³Ø¤Ø§Ù„`;
    document.getElementById('complete-modal').classList.remove('hidden');
}

// Allow Enter key to submit answer
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('answer-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            submitAnswer();
        }
    });
});
</script>
{% endblock %}
