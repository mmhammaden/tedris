{% extends "base.html" %}

{% block title %}التسجيل - منصة تدريس{% endblock %}

{% block content %}
<div x-data="registerPage()" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
        <div class="p-6 border-b">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold" x-text="text[language].title"></h2>
                <div class="flex gap-2">
                    <button @click="language = 'ar'" :class="language === 'ar' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">العربية</button>
                    <button @click="language = 'fr'" :class="language === 'fr' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'" class="px-3 py-1 rounded text-sm">Français</button>
                </div>
            </div>
            <p class="text-gray-600 mt-2" x-text="text[language].subtitle"></p>
        </div>
        
        <form method="POST" class="p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].phone"></label>
                    <input type="tel" name="phone" required maxlength="8" pattern="[0-9]{8}" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-center"
                           :placeholder="text[language].phonePlaceholder">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].nni"></label>
                    <input type="text" name="nni" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           :placeholder="text[language].nniPlaceholder">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].matricule"></label>
                    <input type="text" name="matricule" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           :placeholder="text[language].matriculePlaceholder">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].fullName"></label>
                    <input type="text" name="fullName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           :placeholder="text[language].fullNamePlaceholder">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2" x-text="text[language].password"></label>
                <input type="password" name="password" required minlength="6" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       :placeholder="text[language].passwordPlaceholder">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].userCategory"></label>
                    <select name="userCategory" x-model="userCategory" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" x-text="text[language].userCategoryPlaceholder"></option>
                        <template x-for="category in categories[language]" :key="category.value">
                            <option :value="category.value" x-text="category.label"></option>
                        </template>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].specificRole"></label>
                    <select name="specificRole" required :disabled="!userCategory"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" x-text="text[language].specificRolePlaceholder"></option>
                        <template x-for="role in getRoleOptions()" :key="role.value">
                            <option :value="role.value" x-text="role.label"></option>
                        </template>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].wilaya"></label>
                    <select name="wilaya" x-model="wilaya" @change="loadMoughataas()" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" x-text="text[language].wilayaPlaceholder"></option>
                        <template x-for="w in wilayas[language]" :key="w.value">
                            <option :value="w.value" x-text="w.label"></option>
                        </template>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2" x-text="text[language].moughataa"></label>
                    <select name="moughataa" x-model="moughataa" required :disabled="!wilaya"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" x-text="text[language].moughataPlaceholder"></option>
                        <template x-for="m in moughataas" :key="m.value">
                            <option :value="m.value" x-text="language === 'ar' ? m.label_ar : m.label_fr"></option>
                        </template>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2" x-text="text[language].school"></label>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <select x-show="!isNewSchool" name="school" :required="!isNewSchool"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" x-text="text[language].schoolPlaceholder"></option>
                            <template x-for="school in schools" :key="school.value">
                                <option :value="school.value" x-text="school.label"></option>
                            </template>
                        </select>
                        <input x-show="isNewSchool" type="text" name="school" :required="isNewSchool"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               :placeholder="text[language].newSchoolName">
                    </div>
                    <button type="button" @click="isNewSchool = !isNewSchool" 
                            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50" 
                            x-text="text[language].newSchool"></button>
                </div>
                <input type="hidden" name="isNewSchool" :value="isNewSchool">
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-md font-medium hover:bg-blue-700 transition-colors" x-text="text[language].register"></button>
        </form>

        <div class="p-6 border-t text-center space-y-2">
            <p class="text-sm text-gray-600">
                <span x-text="text[language].haveAccount"></span>
                <a href="{{ url_for('login') }}" class="text-blue-600 hover:underline" x-text="text[language].login"></a>
            </p>
            <a href="{{ url_for('index') }}" class="text-sm text-gray-500 hover:underline block" x-text="text[language].backToHome"></a>
        </div>
    </div>
</div>

<script>
function registerPage() {
    return {
        language: 'ar',
        userCategory: '',
        wilaya: '',
        moughataa: '',
        isNewSchool: false,
        moughataas: [],
        schools: [],
        
        text: {
            ar: {
                title: 'إنشاء حساب جديد',
                subtitle: 'املأ النموذج للتسجيل في منصة تدريس',
                phone: 'رقم الهاتف',
                phonePlaceholder: 'أدخل رقم الهاتف (8 أرقام)',
                nni: 'رقم البطاقة الوطنية',
                nniPlaceholder: 'أدخل رقم البطاقة الوطنية',
                matricule: 'الرقم المرجعي',
                matriculePlaceholder: 'أدخل الرقم المرجعي',
                fullName: 'الاسم الكامل',
                fullNamePlaceholder: 'أدخل الاسم الكامل',
                password: 'كلمة المرور',
                passwordPlaceholder: 'أدخل كلمة المرور (6 أحرف على الأقل)',
                userCategory: 'فئة المستخدم',
                userCategoryPlaceholder: 'اختر فئة المستخدم',
                specificRole: 'الدور المحدد',
                specificRolePlaceholder: 'اختر الدور المحدد',
                wilaya: 'الولاية',
                wilayaPlaceholder: 'اختر الولاية',
                moughataa: 'المقاطعة',
                moughataPlaceholder: 'اختر المقاطعة',
                school: 'المدرسة',
                schoolPlaceholder: 'اختر المدرسة',
                newSchool: 'مدرسة جديدة',
                newSchoolName: 'اسم المدرسة الجديدة',
                register: 'إنشاء الحساب',
                haveAccount: 'لديك حساب بالفعل؟',
                login: 'تسجيل الدخول',
                backToHome: 'العودة للرئيسية'
            },
            fr: {
                title: 'Créer un nouveau compte',
                subtitle: 'Remplissez le formulaire pour vous inscrire sur la plateforme Tedris',
                phone: 'Numéro de téléphone',
                phonePlaceholder: 'Entrez le numéro de téléphone (8 chiffres)',
                nni: 'Numéro de carte nationale',
                nniPlaceholder: 'Entrez le numéro de carte nationale',
                matricule: 'Numéro de référence',
                matriculePlaceholder: 'Entrez le numéro de référence',
                fullName: 'Nom complet',
                fullNamePlaceholder: 'Entrez le nom complet',
                password: 'Mot de passe',
                passwordPlaceholder: 'Entrez le mot de passe (au moins 6 caractères)',
                userCategory: 'Catégorie utilisateur',
                userCategoryPlaceholder: 'Choisissez la catégorie utilisateur',
                specificRole: 'Rôle spécifique',
                specificRolePlaceholder: 'Choisissez le rôle spécifique',
                wilaya: 'Wilaya',
                wilayaPlaceholder: 'Choisissez la wilaya',
                moughataa: 'Moughataa',
                moughataPlaceholder: 'Choisissez la moughataa',
                school: 'École',
                schoolPlaceholder: "Choisissez l'école",
                newSchool: 'Nouvelle école',
                newSchoolName: "Nom de la nouvelle école",
                register: 'Créer le compte',
                haveAccount: 'Vous avez déjà un compte ?',
                login: 'Se connecter',
                backToHome: "Retour à l'accueil"
            }
        },
        
        categories: {
            ar: [
                { value: 'teacher', label: 'معلم' },
                { value: 'student', label: 'طالب' },
                { value: 'admin', label: 'إداري' },
                { value: 'parent', label: 'ولي أمر' }
            ],
            fr: [
                { value: 'teacher', label: 'Enseignant' },
                { value: 'student', label: 'Étudiant' },
                { value: 'admin', label: 'Administrateur' },
                { value: 'parent', label: 'Parent' }
            ]
        },
        
        roles: {
            teacher: {
                ar: [
                    { value: 'primary', label: 'معلم ابتدائي' },
                    { value: 'secondary', label: 'معلم ثانوي' },
                    { value: 'subject_teacher', label: 'معلم مادة' }
                ],
                fr: [
                    { value: 'primary', label: 'Enseignant primaire' },
                    { value: 'secondary', label: 'Enseignant secondaire' },
                    { value: 'subject_teacher', label: 'Enseignant de matière' }
                ]
            },
            student: {
                ar: [
                    { value: 'primary_student', label: 'طالب ابتدائي' },
                    { value: 'secondary_student', label: 'طالب ثانوي' }
                ],
                fr: [
                    { value: 'primary_student', label: 'Élève primaire' },
                    { value: 'secondary_student', label: 'Élève secondaire' }
                ]
            },
            admin: {
                ar: [
                    { value: 'school_admin', label: 'مدير مدرسة' },
                    { value: 'system_admin', label: 'مدير نظام' }
                ],
                fr: [
                    { value: 'school_admin', label: "Directeur d'école" },
                    { value: 'system_admin', label: 'Administrateur système' }
                ]
            },
            parent: {
                ar: [{ value: 'parent', label: 'ولي أمر' }],
                fr: [{ value: 'parent', label: 'Parent' }]
            }
        },
        
        wilayas: {
            ar: [
                { value: 'nouakchott_north', label: 'نواكشوط الشمالية' },
                { value: 'nouakchott_south', label: 'نواكشوط الجنوبية' },
                { value: 'trarza', label: 'الترارزة' },
                { value: 'adrar', label: 'أدرار' }
            ],
            fr: [
                { value: 'nouakchott_north', label: 'Nouakchott Nord' },
                { value: 'nouakchott_south', label: 'Nouakchott Sud' },
                { value: 'trarza', label: 'Trarza' },
                { value: 'adrar', label: 'Adrar' }
            ]
        },
        
        init() {
            this.loadSchools();
        },
        
        getRoleOptions() {
            if (!this.userCategory) return [];
            return this.roles[this.userCategory]?.[this.language] || [];
        },
        
        async loadMoughataas() {
            if (!this.wilaya) {
                this.moughataas = [];
                return;
            }
            
            try {
                const response = await fetch(`/api/moughataas/${this.wilaya}`);
                this.moughataas = await response.json();
                this.moughataa = '';
            } catch (error) {
                console.error('Error loading moughataas:', error);
            }
        },
        
        async loadSchools() {
            try {
                const response = await fetch('/api/schools');
                this.schools = await response.json();
            } catch (error) {
                console.error('Error loading schools:', error);
            }
        }
    }
}
</script>
{% endblock %}
